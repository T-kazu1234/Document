/**
 * oes.enchant.js
 * @version 0.4.9 (2013/3/2)
 * @requires enchant.js v0.4.3 or later
 * @requires tl.enchant.js v0.3.1 or later
 * @requires ex.enchant.js v0.1 or later
 * @author <a href="http://www20.atpages.jp/katwat/wp/">katwat</a>
 * @description
 * enchant.js extension for visual novel.
 */
/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. 
 */
enchant.oes={};(function(){var h=(function(){var a=document.createElement('div');a.setAttribute('ontouchstart','return');return typeof a.ontouchstart==='function'}()),AUDIO_TYPES=(function(){var a,audio;try{audio=new Audio();a=['audio/wav','audio/ogg','audio/mpeg','audio/mp4'].filter(function(v){return audio.canPlayType(v)})}catch(e){a=[]}return a}()),_parseFloat=function(v){return parseFloat(v)||0},getExt=function(b){var a=b.match(/\.\w+$/);if(a){return a[0].slice(1).toLowerCase()}a=b.match(/^data:\w+\/(\w+)/);if(a){return a[1].toLowerCase()}return null},control=null;enchant.oes.OesControl=enchant.Class.create({initialize:function(){if(arguments[0]!==Object.getOwnPropertyDescriptor(enchant.oes.OesControl,'instance').get){throw new Error();}this.log=false;this.logPageMax=100;this.logHtmltag=false;this.autoplay=false;this.autoplayWait=0;this.skipread=false;this.skipreadWait=0;this.clearLog()},clearLog:function(){this._logPages=[];this._logPage=''},logText:{get:function(){return this._logPages.join('<br>')+(this._logPages.length>0?'<br>':'')+this._logPage}},_logAdd:function(a){if(this.log){this._logPage+=a}},_logNewpage:function(){if(this.log){this._logPages.push(this._logPage);if(this.logPageMax>0&&this._logPages.length>this.logPageMax){this._logPages.shift()}this._logPage=''}},_logChosen:function(a){if(this.log){this._logAdd('◆'+a);this._logNewpage()}}});Object.defineProperty(enchant.oes.OesControl,'instance',{get:function(){if(!control){control=new enchant.oes.OesControl(arguments.callee)}return control}});control=enchant.oes.OesControl.instance;enchant.oes.OesScenario=enchant.Class.create(enchant.Scene,{initialize:function(a){enchant.Scene.call(this);this.title=a;this.record=new enchant.oes.OesRecord();this.onenterscenario=null;this.onexitscenario=null;this._chapters=[];this._chapterIdx=-1},addChapter:function(a,b){var c=new enchant.oes.OesChapter(this,b);c.label=a;this._chapters.push(c);this.addChild(c);return c},gotoChapter:function(a){var i;if(typeof(a)==='number'){if(a>=0&&a<this._chapters.length){this._chapterIdx=a;this._run();return}}else if(typeof(a)==='string'){for(i=0;i<this._chapters.length;i++){if(this._chapters[i].label===a){this._chapterIdx=i;this._run();return}}}throw new Error('not found destination : '+a);},nextChapter:function(){this._chapterIdx++;if(this._chapterIdx<this._chapters.length){this._run()}else{this.stop()}},start:function(){var a=0;if(this._chapterIdx>=0){this._chapters[this._chapterIdx].clearLines()}else{enchant.Game.instance.pushScene(this)}if(this.record.chapter){a=this.record.chapter}if(this.onenterscenario){this.onenterscenario()}this.gotoChapter(a)},stop:function(){this.removeAllChildren();enchant.Game.instance.popScene();if(this.onexitscenario){this.onexitscenario()}},_run:function(){this._chapters[this._chapterIdx].start()}});enchant.oes.OesChapter=enchant.Class.create(enchant.Group,{initialize:function(a,b){enchant.Group.call(this);this.scenario=a;this.builder=b;this.label=null;this.onenterchapter=null;this.onexitchapter=null;this._read=null;this.clearLines()},clearLines:function(){this._lines=[];this._lineIdx=-1;this.removeAllChildren()},addLine:function(a){this._lines.push(a);return a},gotoLine:function(a){var i;if(typeof(a)==='number'){if(a>=0&&a<this._lines.length){this._lineIdx=a;this._run();return}}else if(typeof(a)==='string'){for(i=0;i<this._lines.length;i++){if(this._lines[i].label===a){this._lineIdx=i;this._run();return}}}throw new Error('not found destination : '+a);},nextLine:function(){this._lineIdx++;if(this._lineIdx<this._lines.length){this._run()}else{this.stop()}},start:function(){var i;this.builder(this);if(!this._read){this._read=[];i=this._lines.length;while(i--){this._read.push({})}}if(this.onenterchapter){this.onenterchapter()}this.gotoLine(0)},stop:function(a){var b;this.clearLines();if(this.onexitchapter){this.onexitchapter()}b=this.scenario;b.record.chapter=null;b.record.caption=null;b.record.resume=null;b.record.children=null;if(a){b.gotoChapter(a)}else{b.nextChapter()}},_run:function(){this._lines[this._lineIdx]()},_record:function(b,c){var d=this.scenario.record;d.chapter=this.label;d.caption=b;d.resume=c;if(this.childNodes.length>0){d.children=[];this.childNodes.forEach(function(a){var p,v,r={};for(p in a){if(p[0]!=='_'){v=a[p];if((typeof v==='number'&&!isNaN(v))||(typeof v==='string'&&v.length>0)||typeof v==='boolean'){r[p]=v}}}d.children.push(r)})}else{d.children=null}},_resume:function(){var c=null,record=this.scenario.record;if(record.chapter===this.label&&record.resume){c=record.resume;if(record.children&&record.children.length===this.childNodes.length){this.childNodes.forEach(function(a,b){var p,o=record.children[b];for(p in o){a[p]=o[p]}})}}return c},setLabel:function(a){var b=this;this.addLine(function(){b.nextLine()}).label=a},act:function(b){var c=this;return this.addLine(function(){var a=b();if(a){c.gotoLine(a)}else{c.nextLine()}})},jump:function(a){var b=this;return this.addLine(function(){b.gotoLine(a)})},wait:function(a){var b=this;return this.addLine(function(){setTimeout(function(){b.nextLine()},a*1000)})},loadImage:function(a,b){var c=this;return this.addLine(function(){a.load(b,function(){c.nextLine()})})},loadSound:function(a,b,c){var d=this;return this.addLine(function(){a.load(b,c,function(){d.nextLine()})})},print:function(a,b){var c=this;return this.addLine(function(){a._read=c._read[c._lineIdx];a.print(b,function(){c.nextLine()})})},choose:function(c,d){var e=this;return this.addLine(function(){var b=function(a){e.gotoLine(a.to)};c.choose(d,b)})},pick:function(c,d){var e=this;return this.addLine(function(){var b=function(a){e.gotoLine(a.to)};c.pick(d,b)})},tween:function(a,b){var c=this;return this.addLine(function(){var t,i,last,callback=function(){var f;if(b){f=b._callback;delete b._callback;f()}else{c.nextLine()}};if(!(a instanceof Array)){a=[a]}t=0;for(i=0;i<a.length;i++){if(t<a[i].time){t=a[i].time;last=i}}for(i=0;i<a.length;i++){t=new enchant.oes.OesTween(a[i].node,i===last?callback:null);t.tween(a[i])}if(b){b._callback=function(){};c.nextLine()}})},waitTween:function(a){var b=this;return this.addLine(function(){if(a&&a._callback){a._callback=function(){b.nextLine()}}else{b.nextLine()}})},resume:function(){var b=this;return this.addLine(function(){var a=b._resume();if(a){b.gotoLine(a)}else{b.nextLine()}})},exit:function(a){var b=this;return this.addLine(function(){b.stop(a)})},bookmark:function(a,b){var c=this;return this.addLine(function(){if(!b){b=c._lineIdx}c._record(a,b);c.nextLine()})}});enchant.oes.OesLabel=enchant.Class.create(enchant.Entity,{initialize:function(a){enchant.Entity.call(this);if(a){this.text=a}},text:{get:function(){return this._element.innerHTML},set:function(a){this._element.innerHTML=a}},color:{get:function(){return this._style.color},set:function(a){this._style.color=a}}});enchant.oes.OesText=enchant.Class.create(enchant.oes.OesLabel,{initialize:function(){enchant.oes.OesLabel.call(this,'');this.printWait=1/enchant.Game.instance.fps;this.printSpecials=[{match:/[、。！？・]/,delay:5}];this.printIcon={kw:'<img src="kw.gif">',kl:'<img src="kl.gif">',kp:'<img src="kp.gif">'};this.printTags={};this.onprintclick=null;this.chooseShuffle=false;this.chooseInline=false;this.chooseInlineSeparator=', ';this.chooseClass='choose';this.choosePrefix=function(n){return String(n+1)+'.'};this.chooseLingering=0;this.skipable=false;this.onchangeskipable=null;this._read={}},clear:function(){this.text=''},print:function(d,f){var g=this,curtext=this.text,basewait=this.printWait,pos=0,curwait=0,cancelwait=false,keywait=false,autowait=0,skipwait=0,dt=1/enchant.Game.instance.fps,canskip=function(){var b=g._read.pos&&g._read.pos>pos;if(b!==g.skipable){if(g.skipable){curwait=0}g.skipable=b;if(g.onchangeskipable){g.onchangeskipable(b)}}return control.skipread&&b},updatePos=function(a){pos+=a;if(!g._read.pos||g._read.pos<pos){g._read.pos=pos}},updateText=function(a,b){if(!b){control._logAdd(a)}curtext+=a;g.text=curtext;updatePos(a.length)},click=function(){switch(keywait){case'kw':g.text=curtext;curwait=0;break;case'kl':control._logAdd('<br>');curtext+='<br>';g.text=curtext;curwait=0;break;case'kp':control._logNewpage();curtext='';g.text=curtext;cancelwait=false;basewait=g.printWait;curwait=0;break;default:if(pos>0){basewait=0;curwait=0;cancelwait=true}return}if(g.onprintclick){g.onprintclick(keywait)}keywait=false},onclick=function(e){var a=e.target._element.childNodes,i,n;for(i=0;i<a.length;i++){n=a[i];if(n.tagName==='A'&&n.offsetLeft<=e.localX&&n.offsetLeft+n.offsetWidth>e.localX&&n.offsetTop<=e.localY&&n.offsetTop+n.offsetHeight>e.localY){return}}click()},tick=function(){var a,tag,i,c;if(keywait){if(canskip()){if(skipwait>=control.skipreadWait){skipwait=0;click()}else{skipwait+=dt;return}}else if(control.autoplay){if(autowait>=control.autoplayWait){autowait=0;click()}else{autowait+=dt;return}}else{return}}while(basewait===0||curwait<dt||canskip()){while(true){if(pos>=d.length){g._read.pos=pos+1;g.removeEventListener('enterframe',tick);g.removeEventListener('touchend',onclick);if(f){f()}return}c=d[pos];if(c==='<'){a=d.substr(pos).match(/<\/?([^>]*)\/?>/);if(a){updateText(a[0],!control.logHtmltag)}}else if(c==='&'){a=d.substr(pos).match(/&([^;]+);/);if(a){updateText(a[0])}}else if(c==='{'){a=d.substr(pos).match(/\{([^}]*)\}/);if(a){updatePos(a[0].length);a=a[0].replace(/[{}]/g,'').split(/[=,]/);tag=a[0];a.shift();switch(tag){case'kw':case'kl':case'kp':g.text=curtext+g.printIcon[tag];keywait=tag;return;case'np':control._logNewpage();curtext='';g.text=curtext;cancelwait=false;break;case'wt':if(!cancelwait){if(a.length>0){basewait=_parseFloat(a[0])}else{basewait=g.printWait}}break;case'wd':if(!cancelwait){if(a.length>0){basewait=g.printWait*_parseFloat(a[0])}else{basewait=g.printWait}}break;default:if(g.printTags[tag]&&typeof(g.printTags[tag])==='function'){if(g.printTags[tag](a)){return}}break}}}else{for(i=0;i<g.printSpecials.length;i++){if(c.match(g.printSpecials[i].match)){curwait+=basewait*g.printSpecials[i].delay;break}}break}}updateText(d[pos]);curwait+=basewait}curwait-=dt};this.addEventListener('touchend',onclick);this.addEventListener('enterframe',tick)},choose:function(b,c){var d=this,i,j,k,el,tag=this.chooseInline?'span':'div',frag=document.createDocumentFragment(),nodes=[],clicked=function(a){control._logChosen(a._choice.text);d.text='';if(c){c(a._choice)}},onclick=function(){var a=this;if(d.chooseLingering>0){if(h){a.removeEventListener('touchend',onclick,false)}a.removeEventListener('mouseup',onclick,false);nodes.forEach(function(n){if(n!==a){n.style.visibility='hidden'}});setTimeout(function(){clicked(a)},d.chooseLingering*1000)}else{clicked(a)}};if(this.chooseShuffle){i=b.length;while(i){j=Math.floor(Math.random()*i);k=b[--i];b[i]=b[j];b[j]=k}}for(i=0;i<b.length;i++){if(this.chooseInline&&i>0){el=document.createElement(tag);el.innerHTML=this.chooseInlineSeparator;frag.appendChild(el);nodes.push(el)}el=document.createElement(tag);el.innerHTML=this.choosePrefix(i)+b[i].text;el._choice=b[i];el.className=this.chooseClass;if(h){el.style.pointerEvents='all';el.addEventListener('touchend',onclick,false)}el.addEventListener('mouseup',onclick,false);frag.appendChild(el);nodes.push(el)}this._element.appendChild(frag)}});enchant.oes.OesImage=enchant.Class.create(enchant.Sprite,{initialize:function(){enchant.Sprite.call(this);this.sources=[]},set:function(a){if(a&&a!==this.image){this.image=a;this.width=a.width;this.height=a.height}},source:{get:function(){return this.sources.indexOf(this.image)},set:function(a){if(a>=0&&a<this.sources.length){this.set(this.sources[a])}}},load:function(a,b){var c=this,i,onload=function(){this.removeEventListener('load',onload);if(c.sources.indexOf(this)+1===a.length){c.source=0;if(b){b()}}};if(!(a instanceof Array)){a=[a]}this.sources=[];for(i=0;i<a.length;i++){this.sources[i]=enchant.Surface.load(a[i]);this.sources[i].addEventListener('load',onload)}}});enchant.oes.OesSound=enchant.Class.create(enchant.Node,{initialize:function(){enchant.EventTarget.call(this);this.playing=false;this.sources=[];this.onended=null;this._sound=null;this.addEventListener('removedfromscene',function(){this.stop()})},loop:{get:function(){if(this._sound&&this._sound._element){return this._sound._element.loop}return false},set:function(a){if(this._sound&&this._sound._element){this._sound._element.loop=a}}},volume:{get:function(){if(this._sound){return this._sound.volume}return 0},set:function(a){if(this._sound){if(a<0){a=0}else if(a>1){a=1}this._sound.volume=a}}},set:function(a){if(a&&a!==this._sound){this.stop();this._sound=a}},source:{get:function(){return this.sources.indexOf(this._sound)},set:function(a){if(a>=0&&a<this.sources.length){this.set(this.sources[a])}}},load:function(d,e,f){var g=this;if(!(d instanceof Array)){d=[d]}this.sources=[];d.forEach(function(a,b){var c,t,audio,loaded=function(){if(b+1===d.length){g.source=0;if(f){f()}}};c=Object.create(enchant.Sound.prototype);enchant.EventTarget.call(c);g.sources[b]=c;t=e||getExt(a);if(t&&enchant.oes.OesSound.canPlayType(t)){audio=new Audio();audio.onerror=function(){throw new Error('load failed: '+this.src);};audio.addEventListener('canplaythrough',function(){this.removeEventListener('canplaythrough',arguments.callee,false);c.duration=this.duration;loaded()},false);audio.addEventListener('playing',function(){g.playing=true},false);audio.addEventListener('pause',function(){g.playing=false},false);audio.addEventListener('ended',function(){g.playing=false;if(g.onended){g.onended()}},false);audio.autoplay=false;audio.src=a;audio.load();c._element=audio}else{loaded()}})},play:function(){if(this._sound){if(this.playing){if(this.loop){return}this.stop()}this._sound.play()}},pause:function(){if(this._sound&&this.playing){this._sound.pause()}},stop:function(){if(this._sound&&this.playing){this._sound.stop()}}});enchant.oes.OesSound.canPlayType=function(a){a=a.replace('mp3','mpeg');a=a.replace('aac','mp4');if(!a.match(/^audio\//)){a='audio/'+a}return AUDIO_TYPES.indexOf(a)!==-1};enchant.oes.OesPicker=enchant.Class.create({initialize:function(){this.pickClass='pick'},pick:function(d,e){var f=this,onclick=function(){var c=this._pick;d.forEach(function(a){var b=a.image;delete b._pick;b.touchEnabled=false;b.removeClass(f.pickClass);b.removeEventListener('touchend',onclick)});if(e){e(c)}};d.forEach(function(a){var b=a.image;b._pick=a;b.touchEnabled=true;b.addClass(f.pickClass);b.addEventListener('touchend',onclick)})}});enchant.oes.OesTween=enchant.Class.create(enchant.tl.Timeline,{initialize:function(a,b){enchant.tl.Timeline.call(this,a);var c=this;a.addEventListener('enterframe',function(){c.tick();if(c.queue.length===0){this.removeEventListener('enterframe',arguments.callee);if(b){b()}}})}});enchant.oes.OesRecord=enchant.Class.create({initialize:function(){this.date=null;this.chapter=null;this.caption=null;this.resume=null;this.children=null}});enchant.oes.OesRecord.readRecords=function(a,b){if(!b){b=3}var c=localStorage[a];if(c){c=JSON.parse(c)}else{c=[]}while(c.length<b){c.push(new enchant.oes.OesRecord())}return c};enchant.oes.OesRecord.writeRecords=function(a,b){localStorage[a]=JSON.stringify(b)};enchant.oes.OesRecord.deleteRecords=function(a){delete localStorage[a]};enchant.oes.OesRecord.hasRecord=function(b){var c=enchant.oes.OesRecord.readRecords(b);return c.some(function(a){return a.date!==null})}}());